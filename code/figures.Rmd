---
title: "Main Figures"
author: "Chenyang Yuan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arrow)
library(tidyverse)
library(reshape)
library(patchwork)
here::i_am("code/figures.Rmd")
dpi <- 500
```

### Reviewer 2, Major Comment 4

Justify simulation size:

```{r}
areas_Xenium <- read.csv(here::here("validation/DAPI_dilation/areas_Xenium.csv")) %>%
  mutate(dataset = "Xenium 5K")

areas_MERSCOPE <- read.csv(here::here("validation/DAPI_dilation/areas_MERSCOPE_small_size_moderate_dilation.csv")) %>%
  filter(area >= quantile(area, 0.05, na.rm = TRUE), area <= quantile(area, 0.98, na.rm = TRUE)) %>%
  mutate(dataset = "MERSCOPE")

areas_simulation <- read.csv(here::here("simulation/output/intranuclear_area.csv")) %>%
  mutate(dataset = "Simulation")

df <- bind_rows(areas_Xenium, areas_MERSCOPE, areas_simulation) %>%
  mutate(dataset = factor(dataset, levels = c("Xenium 5K", "MERSCOPE", "Simulation")))

df_outliers <- df %>%
  group_by(dataset) %>%
  mutate(q1 = quantile(area, 0.25, na.rm = TRUE),
         q3 = quantile(area, 0.75, na.rm = TRUE),
         iqr = q3 - q1,
         lower = q1 - 1.5 * iqr,
         upper = q3 + 1.5 * iqr) %>%
  filter(area < lower | area > upper) %>%
  ungroup()

p <- ggplot(df, aes(x = dataset, y = area, fill = dataset)) +
  geom_boxplot(position = position_dodge(width = 0.6), width = 0.4, outlier.shape = NA, fatten = 1.2) +
  geom_point(data = df_outliers, aes(x = dataset, y = area, group = dataset), position = position_dodge(width = 0.6), size = 0.2, alpha = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "Cell / Object Area", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

ggsave(here::here("validation/justify_simulation/simulation_area.jpeg"), p, width = 5, height = 6, dpi = dpi)
```

Justify simulation in-soma ratio:

```{r}
df <- read_parquet(here::here("output/MERSCOPE_WT_1/all_granules.parquet"))

cutoff <- 0.2
df_cut <- df[df$in_soma_ratio < cutoff, ]
print(nrow(df_cut[df_cut$in_soma_ratio == 0, ]) / nrow(df_cut))

p <- ggplot(df, aes(x = in_soma_ratio)) +
  geom_histogram(binwidth = 0.025, color = "black", linewidth = 0.25, fill = "#1f77b4", alpha = 0.8) +
  geom_vline(xintercept = cutoff, color = "#b71c2c", linetype = "dashed", linewidth = 0.8) +
  # annotate("text", x = cutoff + 0.02, y = Inf, label = cutoff, color = "#b71c2c", hjust = 0, vjust = 1.5, size = 5) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.2)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = " ", y = "Count") +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15))

ggsave(here::here("validation/justify_simulation/all_granules_in_soma_ratio.jpeg"), p, width = 7, height = 6, dpi = dpi)
```

### Reviewer 2, Major Comment 9

Ambient RNA:

```{r}
df <- read.csv(here::here("output/benchmark/benchmark_diffusion_df.csv"))

cor_test <- cor.test(df$baseline_logFC, df$granule_enrichment, method = "spearman")
cor_test

granule_markers <- c("Syn1", "Cyfip2", "Vamp2", "Bsn", "Stx1a", "Map2", "Nfasc", "Slc17a7", "Gria1", "Map1a", "Ddn", "Gap43", "Mapt", "Gphn", "Homer2", "Slc17a6", "Dlg3", "Nlgn2", "Gria2", "Nlgn1", "Nav1", "Slc32a1", "Tubb3", "Dlg4", "Syt1", "Camk2a", "Nrxn1", "Syp", "Nlgn3", "Cplx2", "Ank3", "Shank1", "Homer1", "Shank3")

df <- df %>%
  mutate(marker_group = if_else(gene %in% granule_markers, "Granule Markers", "Others"))

p <- ggplot(df, aes(x = baseline_logFC, y = granule_enrichment)) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 0.75) +
  geom_point(aes(fill = marker_group), shape = 21, size = 2, color = "black", stroke = 0.1) +
  scale_fill_manual(values = c("Granule Markers" = "#f48488", "Others" = "#a0ccec")) +
  labs(x = "Baseline logFC", y = "Granule enrichment logFC", fill = " ") +
  guides(fill = guide_legend(override.aes = list(size = 4))) +
  theme_classic() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        plot.margin = margin(10, 20, 10, 10),
        legend.position = "bottom",
        legend.box.margin = margin(t = -10, b = 0),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15))

ggsave(here::here("output/benchmark/benchmark_diffusion.jpeg"), p, width = 7, height = 6, dpi = dpi)
```

### Reviewer 3, Major Comment 1

Benchmark sphere merging criteria:

```{r}
df <- read.csv(here::here("output/benchmark/benchmark_rho_MERSCOPE_WT1.csv"))

x_titles <- list(
  merge          = expression(rho[default]),
  merge_volume   = expression(rho[volume]),
  merge_jaccard  = expression(rho[Jaccard]),
  merge_dice     = expression(rho[Dice])
)

for (scenario in c("merge", "merge_volume", "merge_jaccard", "merge_dice")) {

  df_plot <- df[df$scenario %in% c("no_ops", scenario), ]

  # numeric columns only
  num_cols <- names(df_plot)[vapply(df_plot, is.numeric, logical(1))]
  thr_name <- num_cols[colSums(is.na(df_plot[num_cols])) == 1]

  # skip if no threshold column found
  if (length(thr_name) != 1) next

  # replace single NA with -1
  df_plot <- df_plot %>%
    mutate(across(all_of(thr_name), ~ replace(., is.na(.), -1)))
  
  # clean tiny floating-point noise (treat ~0 as 0)
  eps <- 1e-12
  df_plot[[thr_name]][abs(df_plot[[thr_name]]) < eps] <- 0
  
  # preserve original order as it appears in the data
  x_vals <- unique(df_plot[[thr_name]])
  
  # define labels
  x_labels <- as.character(x_vals)
  x_labels[x_vals == -1] <- "No\noperation"
  if (scenario == "merge"){
    x_labels[x_vals == 0]  <- "Drop\ncontained"
  }else{
    x_labels[x_vals == 1]  <- "Drop\ncontained"
  }
  
  df_plot[[thr_name]] <- factor(
    df_plot[[thr_name]],
    levels = x_vals,
    labels = x_labels,
    ordered = TRUE
  )

  # line plots
  p1 <- ggplot(df_plot, aes(x = .data[[thr_name]], y = num_detections)) +
    geom_line(data = df_plot, aes(x = .data[[thr_name]], y = num_detections, group = 1)) +
    geom_point(shape = 21, size = 4, color = "black", fill = "#619CFF") +
    coord_cartesian(ylim = c(600000, NA)) +
    labs(x = x_titles[[scenario]], y = "Number of Detections") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 12))

  ggsave(here::here(paste0("output/benchmark/benchmark_rho_number_of_detections_", scenario, ".jpeg")), p1, width = 9, height = 6, dpi = dpi)
  
  # line plot
  p2 <- ggplot(df_plot, aes(x = .data[[thr_name]], y = avg_aggregates_per_transcript_gnl_only)) +
    geom_line(data = df_plot, aes(x = .data[[thr_name]], y = avg_aggregates_per_transcript_gnl_only, group = 1)) +
    geom_point(shape = 21, size = 4, color = "black", fill = "#00BA38") +
    geom_hline(yintercept = 1, color = "#b71c2c", linetype = "dashed", linewidth = 0.8) +
    coord_cartesian(ylim = c(0.98, NA)) +
    labs(x = x_titles[[scenario]], y = "Number of Detections") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 10),
          axis.text.y = element_text(size = 12))

  ggsave(here::here(paste0("output/benchmark/benchmark_rho_aggregates_per_transcript_", scenario, ".jpeg")), p2, width = 9, height = 6, dpi = dpi)
  
}
```

### Reviewer 3, Major Comment 2

Benchmark in-soma and negative control filtering:

```{r}
df <- read.csv(here::here("output/benchmark/benchmark_filtering_results.csv"))

scenario_x <- c(in_soma_only = "in_soma_thr", nc_only = "nc_thr", in_soma_and_nc = "in_soma_thr")

# Pretty x-axis title (not the raw column name)
x_title <- function(xvar) {
  if (xvar == "nc_thr") "Negative control filtering threshold" else "In-soma filtering threshold"
}

# tick labels: 0, 0.0001, otherwise 1 decimal
fmt_thr <- function(x) {
  ifelse(
    is.na(x), NA_character_,
    ifelse(
      x == 0, "0",
      ifelse(abs(x - 0.0001) < 1e-12, "0.0001", sprintf("%.1f", x))
    )
  )
}

for (scn in names(scenario_x)) {
  
  use_dashed <- scn != "nc_only"

  xvar <- scenario_x[[scn]]

  df_s <- df %>%
    filter(scenario == scn) %>%
    mutate(x_num = as.numeric(.data[[xvar]]))

  # numeric-sorted discrete x with 0 on the RIGHT
  levs_num <- sort(unique(df_s$x_num), decreasing = TRUE, na.last = NA)
  levs_chr <- as.character(levs_num)

  df_s <- df_s %>%
    mutate(x_fct = factor(as.character(x_num), levels = levs_chr),
           msr_ymin = q25_sphere_r,
           msr_ymax = q75_sphere_r)
  
  df_highlight <- df_s %>%
    filter(x_num == 0.1)

  # named label map (names MUST match factor levels)
  x_labels <- setNames(fmt_thr(levs_num), levs_chr)

  # solid line connects only non-zero thresholds
  df_line <- df_s %>% filter(x_num != 0)

  # dashed line connects 0 to others (will only draw where y is non-NA)
  df_dash <- df_s %>% filter(x_num == 0 | x_num != 0)

  # --- 1) n_detections ---
  p_n_det <- ggplot() +
    {if (use_dashed) {
      list(geom_line(data = df_line, aes(x = x_fct, y = n_detections, group = 1)),
           geom_line(data = df_s, aes(x = x_fct, y = n_detections, group = 1), linetype = "dashed"))
    } else {
      geom_line(data = df_s, aes(x = x_fct, y = n_detections, group = 1))
    }} +
    # geom_vline(xintercept = which(levels(df_s$x_fct) == "0.1"), color = "#b71c2c", linetype = "dashed") +
    geom_point(data = df_s, aes(x = x_fct, y = n_detections), shape = 21, size = 4, color = "black", fill = "#F8766D") +
    geom_point(data = df_highlight, aes(x = x_fct, y = n_detections), shape = 21, size = 6, fill = NA, color = "#b71c2c", stroke = 1.1) +
    scale_x_discrete(drop = FALSE, labels = x_labels) +
    coord_cartesian(ylim = c(0, 1200000)) +
    labs(title = " ", x = x_title(xvar), y = "Number of detections") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 15),
          axis.text.y = element_text(size = 12))
  
  ggsave(here::here(paste0("output/benchmark/benchmark_filtering_", scn, "_number_of_detections.jpeg")), p_n_det, width = 8, height = 6, dpi = dpi)

  # --- 2) median_sphere_r ---
  p_msr <- ggplot() +
    {if (use_dashed) {
      list(geom_line(data = df_line, aes(x = x_fct, y = q50_sphere_r, group = 1)),
           geom_line(data = df_s, aes(x = x_fct, y = q50_sphere_r, group = 1), linetype = "dashed"))
    } else {
      geom_line(data = df_s, aes(x = x_fct, y = q50_sphere_r, group = 1))
    }} +
    # geom_vline(xintercept = which(levels(df_s$x_fct) == "0.1"), color = "#b71c2c", linetype = "dashed") +
    geom_errorbar(data = df_s, aes(x = x_fct, ymin = msr_ymin, ymax = msr_ymax), width = 0.15) +
    geom_point(data = df_s, aes(x = x_fct, y = q50_sphere_r), shape = 21, size = 4, color = "black", fill = "#00BA38") +
    geom_point(data = df_highlight, aes(x = x_fct, y = q50_sphere_r), shape = 21, size = 6, fill = NA, color = "#b71c2c", stroke = 1.1) +
    scale_x_discrete(drop = FALSE, labels = x_labels) +
    coord_cartesian(ylim = c(0.5, 1.5)) +
    labs(title = " ", x = x_title(xvar), y = "Median aggregate radius") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 15),
          axis.text.y = element_text(size = 12))
  
  ggsave(here::here(paste0("output/benchmark/benchmark_filtering_", scn, "_median_aggregate_radius.jpeg")), p_msr, width = 8, height = 6, dpi = dpi)

  # --- 3) mean_in_soma_ratio ---
  p_misr <- ggplot() +
    {if (use_dashed) {
      list(geom_line(data = df_line, aes(x = x_fct, y = mean_in_soma_ratio, group = 1)),
           geom_line(data = df_s, aes(x = x_fct, y = mean_in_soma_ratio, group = 1), linetype = "dashed"))
    } else {
      geom_line(data = df_s, aes(x = x_fct, y = mean_in_soma_ratio, group = 1))
    }} +
    # geom_vline(xintercept = which(levels(df_s$x_fct) == "0.1"), color = "#b71c2c", linetype = "dashed") +
    geom_point(data = df_s, aes(x = x_fct, y = mean_in_soma_ratio), shape = 21, size = 4, color = "black", fill = "#619CFF") +
    geom_point(data = df_highlight, aes(x = x_fct, y = mean_in_soma_ratio), shape = 21, size = 6, fill = NA, color = "#b71c2c", stroke = 1.1) +
    scale_x_discrete(drop = FALSE, labels = x_labels) +
    coord_cartesian(ylim = c(0, 0.5)) +
    labs(title = " ", x = x_title(xvar), y = "Mean in-soma ratio") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 15),
          axis.text.y = element_text(size = 12))
  
  ggsave(here::here(paste0("output/benchmark/benchmark_filtering_", scn, "_mean_in_soma_ratio.jpeg")), p_misr, width = 8, height = 6, dpi = dpi)
}
```

### Reviewer 3, Major Comment 3

```{r}
df_default <- read.csv(here::here("output/benchmark/benchmark_sphere_metrics_default.csv"))
df_fixed <- read.csv(here::here("output/benchmark/benchmark_sphere_metrics_fixed.csv"))
df_expand <- read.csv(here::here("output/benchmark/benchmark_sphere_metrics_expand.csv"))
df_shrink <- read.csv(here::here("output/benchmark/benchmark_sphere_metrics_shrink.csv"))

df_all <- bind_rows(df_default, df_fixed, df_expand, df_shrink) %>%
  mutate(setting = factor(setting, levels = c("default", "fixed", "expand", "shrink"))) %>%
  filter(n_transcripts > 0)

# ==================== number of transcripts ==================== #
df_outliers_transcripts <- df_all %>%
  group_by(setting) %>%
  mutate(q1 = quantile(n_transcripts, 0.25, na.rm = TRUE),
         q3 = quantile(n_transcripts, 0.75, na.rm = TRUE),
         iqr = q3 - q1,
         lower = q1 - 1.5 * iqr,
         upper = q3 + 1.5 * iqr) %>%
  filter(n_transcripts < lower | n_transcripts > upper) %>%
  ungroup()

p1 <- ggplot(df_all, aes(x = setting, y = n_transcripts, fill = setting)) +
  geom_boxplot(position = position_dodge(width = 0.6), width = 0.5, outlier.shape = NA, fatten = 1.2) +
  geom_point(data = df_outliers_transcripts, aes(x = setting, y = n_transcripts, group = setting), position = position_dodge(width = 0.6), size = 0.2, alpha = 0.5, show.legend = FALSE) +
  scale_y_log10() +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "Number of transcripts", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

ggsave(here::here(paste0("output/benchmark/benchmark_sphere_num_transcripts.jpeg")), p1, width = 8, height = 6, dpi = dpi)

# ==================== number of unique genes ==================== #
df_outliers_genes <- df_all %>%
  group_by(setting) %>%
  mutate(q1 = quantile(n_unique_genes, 0.25, na.rm = TRUE),
         q3 = quantile(n_unique_genes, 0.75, na.rm = TRUE),
         iqr = q3 - q1,
         lower = q1 - 1.5 * iqr,
         upper = q3 + 1.5 * iqr) %>%
  filter(n_unique_genes < lower | n_unique_genes > upper) %>%
  ungroup()

p2 <- ggplot(df_all, aes(x = setting, y = n_unique_genes, fill = setting)) +
  geom_boxplot(position = position_dodge(width = 0.6), width = 0.5, outlier.shape = NA, fatten = 1.2) +
  geom_point(data = df_outliers_genes, aes(x = setting, y = n_unique_genes, group = setting), position = position_dodge(width = 0.6), size = 0.2, alpha = 0.5, show.legend = FALSE) +
  scale_y_log10() +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "Number of unique genes", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

ggsave(here::here(paste0("output/benchmark/benchmark_sphere_num_unique_genes.jpeg")), p2, width = 8, height = 6, dpi = dpi)

# ==================== in-soma ratio ==================== #
df_outliers_in_soma <- df_all %>%
  filter(in_soma_ratio > 0) %>%
  group_by(setting) %>%
  mutate(q1 = quantile(in_soma_ratio, 0.25, na.rm = TRUE),
         q3 = quantile(in_soma_ratio, 0.75, na.rm = TRUE),
         iqr = q3 - q1,
         lower = q1 - 1.5 * iqr,
         upper = q3 + 1.5 * iqr) %>%
  filter(in_soma_ratio < lower | in_soma_ratio > upper) %>%
  ungroup()

p <- ggplot(subset(df_all, in_soma_ratio > 0), aes(x = setting, y = in_soma_ratio, fill = setting)) +
  geom_boxplot(position = position_dodge(width = 0.6), width = 0.5, outlier.shape = NA, fatten = 1.2) +
  geom_point(data = df_outliers_in_soma, aes(x = setting, y = in_soma_ratio, group = setting), position = position_dodge(width = 0.6), size = 0.2, alpha = 0.5, show.legend = FALSE) +
  scale_y_log10() +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "In-soma ratio", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

df_nonzero_pt <- df_all %>%
  group_by(setting) %>%
  summarise(prop_nonzero = mean(in_soma_ratio > 0, na.rm = TRUE), .groups = "drop")

p_nonzero_dot <- ggplot(df_nonzero_pt, aes(x = setting, y = prop_nonzero)) +
  geom_point(shape = 21, color = "black", fill = "#F8766D", size = 3) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = NULL, y = "% non-zero") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12))

p3 <- (p / p_nonzero_dot) + plot_layout(heights = c(4, 1))

ggsave(here::here(paste0("output/benchmark/benchmark_sphere_in_soma_ratio.jpeg")), p3, width = 8, height = 8, dpi = dpi)

p3_violin <- ggplot(df_all, aes(x = setting, y = in_soma_ratio, fill = setting)) +
  geom_violin(position = position_dodge(width = 0.6), width = 0.5, scale = "width") +
  scale_y_sqrt() +
  # scale_y_continuous(trans = scales::trans_new(name = "fourth_root", transform = function(x) x^(1/4), inverse = function(x) x^4)) +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "In-soma ratio", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

ggsave(here::here(paste0("output/benchmark/benchmark_sphere_in_soma_ratio_violin.jpeg")), p3_violin, width = 8, height = 6, dpi = dpi)

# ==================== negative control ratio ==================== #
df_outliers_nc <- df_all %>%
  filter(nc_ratio > 0) %>%
  group_by(setting) %>%
  mutate(q1 = quantile(nc_ratio, 0.25, na.rm = TRUE),
         q3 = quantile(nc_ratio, 0.75, na.rm = TRUE),
         iqr = q3 - q1,
         lower = q1 - 1.5 * iqr,
         upper = q3 + 1.5 * iqr) %>%
  filter(nc_ratio < lower | nc_ratio > upper) %>%
  ungroup()

p <- ggplot(subset(df_all, nc_ratio > 0), aes(x = setting, y = nc_ratio, fill = setting)) +
  geom_boxplot(position = position_dodge(width = 0.6), width = 0.5, outlier.shape = NA, fatten = 1.2) +
  geom_point(data = df_outliers_nc, aes(x = setting, y = nc_ratio, group = setting), position = position_dodge(width = 0.6), size = 0.2, alpha = 0.5, show.legend = FALSE) +
  scale_y_log10() +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "Negative control ratio", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

df_nonzero_pt <- df_all %>%
  group_by(setting) %>%
  summarise(prop_nonzero = mean(nc_ratio > 0, na.rm = TRUE), .groups = "drop")

p_nonzero_dot <- ggplot(df_nonzero_pt, aes(x = setting, y = prop_nonzero)) +
  geom_point(shape = 21, color = "black", fill = "#F8766D", size = 3) +
  scale_y_continuous(labels = scales::percent) +
  labs(x = NULL, y = "% non-zero") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 12))

p4 <- (p / p_nonzero_dot) + plot_layout(heights = c(4, 1))

ggsave(here::here(paste0("output/benchmark/benchmark_sphere_negative_control_ratio.jpeg")), p4, width = 8, height = 8, dpi = dpi)

p4_violin <- ggplot(df_all, aes(x = setting, y = nc_ratio, fill = setting)) +
  geom_violin(position = position_dodge(width = 0.6), width = 0.5, scale = "width") +
  scale_y_sqrt() +
  # scale_y_continuous(trans = scales::trans_new(name = "fourth_root", transform = function(x) x^(1/4), inverse = function(x) x^4)) +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "Negative control ratio", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

ggsave(here::here(paste0("output/benchmark/benchmark_sphere_negative_control_ratio_violin.jpeg")), p4_violin, width = 8, height = 6, dpi = dpi)
```





















