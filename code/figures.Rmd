---
title: "Validation Figures"
author: "Chenyang Yuan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arrow)
library(tidyverse)
library(reshape)
library(patchwork)
here::i_am("code/figures.Rmd")
dpi <- 500
```

### Reviewer 2, Major Comment 4

Justify simulation size:

```{r}
areas_Xenium <- read.csv(here::here("validation/DAPI_dilation/areas_Xenium.csv")) %>%
  mutate(dataset = "Xenium 5K")

areas_MERSCOPE <- read.csv(here::here("validation/DAPI_dilation/areas_MERSCOPE_small_size_moderate_dilation.csv")) %>%
  filter(area >= quantile(area, 0.05, na.rm = TRUE), area <= quantile(area, 0.98, na.rm = TRUE)) %>%
  mutate(dataset = "MERSCOPE")

areas_simulation <- read.csv(here::here("simulation/output/intranuclear_area.csv")) %>%
  mutate(dataset = "Simulation")

df <- bind_rows(areas_Xenium, areas_MERSCOPE, areas_simulation) %>%
  mutate(dataset = factor(dataset, levels = c("Xenium 5K", "MERSCOPE", "Simulation")))

df_outliers <- df %>%
  group_by(dataset) %>%
  mutate(q1 = quantile(area, 0.25, na.rm = TRUE),
         q3 = quantile(area, 0.75, na.rm = TRUE),
         iqr = q3 - q1,
         lower = q1 - 1.5 * iqr,
         upper = q3 + 1.5 * iqr) %>%
  filter(area < lower | area > upper) %>%
  ungroup()

p <- ggplot(df, aes(x = dataset, y = area, fill = dataset)) +
  geom_boxplot(position = position_dodge(width = 0.6), width = 0.4, outlier.shape = NA, fatten = 1.2) +
  geom_point(data = df_outliers, aes(x = dataset, y = area, group = dataset), position = position_dodge(width = 0.6), size = 0.2, alpha = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = scales::alpha(c("#1f77b4", "#1f77b4", "#1f77b4"), 0.8)) +
  labs(x = NULL, y = "Cell / Object Area", fill = NULL) +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15),
        legend.position = "none")

ggsave(here::here("validation/justify_simulation/simulation_area.jpeg"), p, width = 5, height = 6, dpi = dpi)
```

Justify simulation in-soma ratio:

```{r}
f <- read_parquet(here::here("output/MERSCOPE_WT_1/all_granules.parquet"))

cutoff <- 0.2
df_cut <- df[df$in_soma_ratio < cutoff, ]
print(nrow(df_cut[df_cut$in_soma_ratio == 0, ]) / nrow(df_cut))

p <- ggplot(df, aes(x = in_soma_ratio)) +
  geom_histogram(binwidth = 0.025, color = "black", linewidth = 0.25, fill = "#6fafd2", alpha = 1) +
  geom_vline(xintercept = cutoff, color = "#b71c2c", linetype = "dashed", linewidth = 0.8) +
  # annotate("text", x = cutoff + 0.02, y = Inf, label = cutoff, color = "#b71c2c", hjust = 0, vjust = 1.5, size = 5) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.2)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = " ", y = "Count") +
  theme_classic() +
  theme(axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.text.y = element_text(size = 15))

ggsave(here::here("validation/justify_simulation/all_granules_in_soma_ratio.jpeg"), p, width = 7, height = 6, dpi = dpi)
```

### Reviewer 3, Major Comment 2

Benchmarking in-soma and negative control filtering:

```{r}
df <- read.csv(here::here("output/benchmark/benchmark_filtering_results.csv"))

scenario_x <- c(in_soma_only = "in_soma_thr", nc_only = "nc_thr", in_soma_and_nc = "in_soma_thr")

# Pretty x-axis title (not the raw column name)
x_title <- function(xvar) {
  if (xvar == "nc_thr") "Negative control filtering threshold" else "In-soma filtering threshold"
}

# tick labels: 0, 0.0001, otherwise 1 decimal
fmt_thr <- function(x) {
  ifelse(
    is.na(x), NA_character_,
    ifelse(
      x == 0, "0",
      ifelse(abs(x - 0.0001) < 1e-12, "0.0001", sprintf("%.1f", x))
    )
  )
}

for (scn in names(scenario_x)) {
  
  use_dashed <- scn != "nc_only"

  xvar <- scenario_x[[scn]]

  df_s <- df %>%
    filter(scenario == scn) %>%
    mutate(x_num = as.numeric(.data[[xvar]]))

  # numeric-sorted discrete x with 0 on the LEFT
  levs_num <- sort(unique(df_s$x_num), na.last = NA)
  levs_chr <- as.character(levs_num)

  df_s <- df_s %>%
    mutate(x_fct = factor(as.character(x_num), levels = levs_chr))

  # named label map (names MUST match factor levels)
  x_labels <- setNames(fmt_thr(levs_num), levs_chr)

  # solid line connects only non-zero thresholds
  df_line <- df_s %>% filter(x_num != 0)

  # dashed line connects 0 to others (will only draw where y is non-NA)
  df_dash <- df_s %>% filter(x_num == 0 | x_num != 0)

  # --- 1) n_detections ---
  p_n_det <- ggplot() +
    {if (use_dashed) {
      list(geom_line(data = df_line, aes(x = x_fct, y = n_detections, group = 1)),
           geom_line(data = df_s, aes(x = x_fct, y = n_detections, group = 1), linetype = "dashed"))
    } else {
      geom_line(data = df_s, aes(x = x_fct, y = n_detections, group = 1))
    }} +
    geom_point(data = df_s, aes(x = x_fct, y = n_detections), shape = 21, size = 3, color = "black", fill = "#F8766D") +
    scale_x_discrete(drop = FALSE, labels = x_labels) +
    coord_cartesian(ylim = c(0, 1200000)) +
    labs(title = " ", x = x_title(xvar), y = "Number of detections") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 15),
          axis.text.y = element_text(size = 12))
  
  ggsave(here::here(paste0("output/benchmark/benchmark_filtering_", scn, "_number_of_detections.jpeg")), p_n_det, width = 8, height = 6, dpi = dpi)

  # --- 2) mean_sphere_r ---
  p_msr <- ggplot() +
    {if (use_dashed) {
      list(geom_line(data = df_line, aes(x = x_fct, y = mean_sphere_r, group = 1)),
           geom_line(data = df_s, aes(x = x_fct, y = mean_sphere_r, group = 1), linetype = "dashed"))
    } else {
      geom_line(data = df_s, aes(x = x_fct, y = mean_sphere_r, group = 1))
    }} +
    geom_point(data = df_s, aes(x = x_fct, y = mean_sphere_r), shape = 21, size = 3, color = "black", fill = "#00BA38") +
    scale_x_discrete(drop = FALSE, labels = x_labels) +
    coord_cartesian(ylim = c(0.75, 1.25)) +
    labs(title = " ", x = x_title(xvar), y = "Mean aggregate radius") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 15),
          axis.text.y = element_text(size = 12))
  
  ggsave(here::here(paste0("output/benchmark/benchmark_filtering_", scn, "_mean_aggregate_radius.jpeg")), p_msr, width = 8, height = 6, dpi = dpi)

  # --- 3) mean_in_soma_ratio ---
  p_misr <- ggplot() +
    {if (use_dashed) {
      list(geom_line(data = df_line, aes(x = x_fct, y = mean_in_soma_ratio, group = 1)),
           geom_line(data = df_s, aes(x = x_fct, y = mean_in_soma_ratio, group = 1), linetype = "dashed"))
    } else {
      geom_line(data = df_s, aes(x = x_fct, y = mean_in_soma_ratio, group = 1))
    }} +
    geom_point(data = df_s, aes(x = x_fct, y = mean_in_soma_ratio), shape = 21, size = 3, color = "black", fill = "#619CFF") +
    scale_x_discrete(drop = FALSE, labels = x_labels) +
    coord_cartesian(ylim = c(0, 0.5)) +
    labs(title = " ", x = x_title(xvar), y = "Mean in-soma ratio") +
    theme_classic() +
    theme(axis.title = element_text(size = 15),
          axis.text.x = element_text(size = 15),
          axis.text.y = element_text(size = 12))
  
  ggsave(here::here(paste0("output/benchmark/benchmark_filtering_", scn, "_mean_in_soma_ratio.jpeg")), p_misr, width = 8, height = 6, dpi = dpi)
}
```

### Reviewer 2, Comment 9

Ambient RNA:

```{r}
df <- read.csv(here::here("output/benchmark/benchmark_diffusion_df.csv"))

cor_test <- cor.test(df$baseline_logFC, df$granule_enrichment, method = "spearman")
cor_test

granule_markers <- c("Syn1", "Cyfip2", "Vamp2", "Bsn", "Stx1a", "Map2", "Nfasc", "Slc17a7", "Gria1", "Map1a", "Ddn", "Gap43", "Mapt", "Gphn", "Homer2", "Slc17a6", "Dlg3", "Nlgn2", "Gria2", "Nlgn1", "Nav1", "Slc32a1", "Tubb3", "Dlg4", "Syt1", "Camk2a", "Nrxn1", "Syp", "Nlgn3", "Cplx2", "Ank3", "Shank1", "Homer1", "Shank3")

df <- df %>%
  mutate(marker_group = if_else(gene %in% granule_markers, "Granule Markers", "Others"))

p <- ggplot(df, aes(x = baseline_logFC, y = granule_enrichment)) +
  geom_smooth(method = "lm", se = TRUE, color = "black", linewidth = 0.75) +
  geom_point(aes(fill = marker_group), shape = 21, size = 2, color = "black", stroke = 0.1) +
  scale_fill_manual(values = c("Granule Markers" = "#f48488", "Others" = "#a0ccec")) +
  labs(x = "Baseline logFC", y = "Granule enrichment logFC", fill = " ") +
  guides(fill = guide_legend(override.aes = list(size = 4))) +
  theme_classic() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        plot.margin = margin(10, 20, 10, 10),
        legend.position = "bottom",
        legend.box.margin = margin(t = -10, b = 0),
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 15))

ggsave(here::here("output/benchmark/benchmark_diffusion.jpeg"), p, width = 7, height = 6, dpi = dpi)
```


















